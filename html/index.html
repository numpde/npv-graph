<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Funky NPV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"/>


  <script src="js/jquery.ui.touch-punch.min.js"></script>

<!--  <script src="js/jquery.mobile-events.min.js"></script>-->
<!--  <script src="js/jquery-doubletap.js"></script>-->

  <link rel="stylesheet" type="text/css" href="css/main.css">

  <style type="text/css">
  </style>

</head>
<body>
<script>
    var defaultBlobW = 60;
    var defaultBlobH = 40;

    var nblobs = 0;
    var nlines = 0;

    function log(evt, what) {
      console.log({'event': (evt.type ? evt.type : evt), 'more': what});
    }

    function silence(evt) {
        evt.stopPropagation();
        evt.preventDefault();
    }


    function getLinesFromTo(a, b) {
      var lines = $("line").filter(function(i) {
        var line = $(this);
        var ia = (a === null ? true : (line.data('a') == a.data('id')));
        var ib = (b === null ? true : (line.data('b') == b.data('id')));
        return (ia & ib);
      });
      return lines;
    }

    function getVarsFromBlobs() {
      var vars = $("div.blob").toArray().reduce(
        function(acc, b) {
          var v = $(b).data('caption');
          if (v) {
            acc[v] = $(b).data('value');
          }
          return acc;
        },
        {}
      );
      return vars;
    }

    function evaluateBlob(b) {
      var vars = getVarsFromBlobs();

      // This blob
      var b = $(b);
      // Sum from incoming connections
      var lines = getLinesFromTo(null, b).toArray();
      var insum = lines.reduce(
        function(s, line) {
          var a = $("div.blob[name=" + $(line).data('a') + "]");
          return s + a.data('value');
        },
        0
      );
      // Parse formula
      var f = b.data('formula');
      // Compute this blob's result
      var r = NaN;
      try {
        f = f.replace("#", "(" + insum + ")");
        for (var v in vars) {
          f = f.replace("$" + v, "(" + vars[v] + ")");
        }
        f = f.replace("%", " * 0.01");
        r = parseFloat(eval(f));
      } catch(err) {
        r = NaN;
      }
      // Save result
      b.data('value', r);

      // Visualize result
      b.find(".caption").text(b.data('caption'));

      var old_val = b.find(".value").text();
      var new_val = "" + b.data('value');
      b.find(".value").text(new_val);

      if (old_val != new_val) {
        b.addClass("unsettled");
      } else {
        b.removeClass("unsettled");
      }
    }

    function evaluateAllBlobs() {
      $("div.blob").each(function() { evaluateBlob($(this)); });
    }

    // On-ready: set auto-evaluate
    $(function() {
      setInterval(
        function() {
          evaluateAllBlobs();
        },
        1000
      );
    });

    function unselectAllBlobs() {
        var blobs = $("div.blob");
        blobs.removeClass("selected");
        blobs.draggable('enable');
        blobs.resizable('disable');
    }

    // On-ready: register SVG arrowhead
    $( function() {
      svg = '<svg height="100%" width="100%" xmlns="http://www.w3.org/2000/svg">' +
            '<defs>' +
            '<marker id="arrowhead" class="arrow" viewBox="0 0 10 10" refX="7" refY="5" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" />' +
            '</marker>' +
            '</defs>' +
            //'<line class="arrow" x1="20" y1="60" x2="100" y2="200" marker-end="url(#arrowhead)"/>' +
            '</svg>';
      $("div.canvas").append($(svg));
    } );

    function prepareLine(line) {
      line.click(function(evt) {
      });
    }

    function parseUserInputForBlob(b) {
      var f = b.data('userinput');

      // Parse formula
      f = f.includes(':') ? f.split(":", 2) : ["", f];
      b.data('caption', f[0]);
      b.data('formula', f[1]);

      // The computed value
      b.data('value', NaN);
    }

    function promptFormulaForBlob(b) {
      var f = prompt("Specify cell in the format Caption: Formula", b.data('userinput'));
      if (f) {
        b.data('userinput', f);
        parseUserInputForBlob(b);

        // Trigger computation
        evaluateBlob(b);
        evaluateAllBlobs();
      }
    }


    function correctLinePosition(line) {
      var a = $("div.blob[name=" + line.data('a') + "]");
      var b = $("div.blob[name=" + line.data('b') + "]");

      function getLeft(x) {
        return x.position().left + parseInt(x.css("border-left-width")) + parseInt(x.css("margin-left")) + parseInt(x.css("paddling-left"));
      }

      // https://stackoverflow.com/questions/31114656/jquery-position-include-margin
      var x1 = a.position().left + a.innerWidth() / 2;
      var y1 = a.position().top + a.innerHeight() / 2;
      var x2 = b.position().left + b.innerWidth() / 2;
      var y2 = b.position().top + b.innerHeight() / 2;
      var s = Math.min(0.48, 0.55 * Math.sqrt(a.outerWidth() ** 2 + a.outerHeight() ** 2) / (1 + Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2)));
      var t = Math.min(0.48, 0.55 * Math.sqrt(b.outerWidth() ** 2 + b.outerHeight() ** 2) / (1 + Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2)));
      line.attr('x1', x1 + s * (x2 - x1));
      line.attr('y1', y1 + s * (y2 - y1));
      line.attr('x2', x2 - t * (x2 - x1));
      line.attr('y2', y2 - t * (y2 - y1));
    }

    function correctLinesForBlob(blob) {
      $("line").each(function(i) {
        var line = $(this);
        if ((line.data('a') == blob.data('id')) || (line.data('b') == blob.data('id'))) {
          correctLinePosition(line);
        }
      })
    }

    function connectBlobs(a, b) {
      var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      $("div.canvas svg").append(line);

      // https://stackoverflow.com/questions/8638621/jquery-svg-why-cant-i-addclass
      line.classList.add("arrow");

      line = $(line);

      line.attr('name', nlines++);
      line.data('a', a.data('id'));
      line.data('b', b.data('id'));

      prepareLine(line);

      correctLinePosition(line);
    }

    function disconnectBlobs(a, b) {
      var lines = getLinesFromTo(a, b);
      lines.remove();
    }

    function prepareBlob(blob) {
      // Order matters: https://stackoverflow.com/a/18032193

      blob.data('id', nblobs++);
      blob.attr('name', blob.data('id'));

      blob.data('userinput', "Result: #");
      parseUserInputForBlob(blob);

      blob.append($('<span class="caption" /> <br> <span class="value" />'));

      function selection(evt) {
        if (blob.hasClass("selected")) {
          unselectAllBlobs();
        } else {
          unselectAllBlobs();
          $(blob).addClass("selected");
          $(blob).resizable('enable');
          // Too late?
          //$(blob).draggable('disable');
        }
        silence(evt);
      }

      blob.draggable({
        // https://jqueryui.com/draggable/#events
        'containment': "parent",
        'start': function(evt) {
          // Too late to unselect here?
          unselectAllBlobs();
        },
        'stop': function(evt) {
        },
        'drag': function(evt) {
          correctLinesForBlob($(this));
        },
      });

      //blob.doubletap(silence);

      blob.dblclick(silence);
      //blob.dblclick(log);

      blob.click(function(evt) {
        var a = $("div.blob.selected");
        var b = $(this);
        if (a.length) {
          unselectAllBlobs();
          if (a.is(b)) {
            promptFormulaForBlob(a);
          } else {
            var lines = getLinesFromTo(a, b);
            if (lines.length) {
              disconnectBlobs(a, b);
            } else {
              connectBlobs(a, b);
            }
          }
        } else {
          selection(evt);
        }
        silence(evt);
      });

      blob.resizable({
        disabled: true,
        containment: "parent",
        minHeight: 30,
        minWidth: 50,
        resize: function(evt) {
          correctLinesForBlob($(this));
          unselectAllBlobs();
        },
      });
      //

      return blob;
    }

    function addBlob(to, param) {
      var ox = param.cx - param.w / 2;
      var oy = param.cy - param.h / 2;
      var css = {left: ox, top: oy, width: param.w, height: param.h};
      var blob = $('<div class="blob ui-widget-content"></div>');
      $(to).append(blob.css(css));
      prepareBlob(blob);
    }

    // On ready: blob creation
    $(
      function() {
        var canvas = $("div.canvas");
        canvas.mousedown(silence);

        canvas.click(
          {},
          function(evt) {
            unselectAllBlobs();
          }
        );

        canvas.dblclick(
          {},
          function(evt) {
            addBlob(this, {cx: evt.offsetX, cy: evt.offsetY, w: defaultBlobW, h: defaultBlobH});
          }
        );
      }
    );

    // On-ready
    $(function() {
      $(document).keyup(function(e) {
        if (e.keyCode === 13) {

        }
        if (e.keyCode === 27) {
          unselectAllBlobs();
        }
      });
    });
  </script>


<div class="container">
  <div class="row">
    <div class="col">
      <h1>
        NPV decision tree
      </h1>
    </div>
  </div>
  <div class="row">
    <div class="col" style="font-size:80%">
      This is a simple graphical tool for
      <a href="https://www.investopedia.com/terms/n/npv.asp" target="_blank">NPV</a>
      decision tree computation.
      Double-click to add a new cell.
      Click a cell to activate.
      Click again to edit its formula,
      or another cell to dis/connect.
      The formula should be like
      <ul>
        <li>
          <span class="formula">r: 15%</span>
          --
          this cell, called <span class="formula">r</span>, has the value <span class="formula">15%</span>,
          <em>or</em>
        </li>
        <li>
          <span class="formula">PV: # / ((1 + $r) ** 2)</span>
          --
          this cell, called <span class="formula">PV</span>, is the sum <span class="formula">#</span>
          of inflow cells discounted over two years by <span class="formula">r</span>.
        </li>
      </ul>
      You can use the
      <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math" target="_blank">Math object</a>,
      e.g.
      <span class="formula">Math.max(#, 0)</span>.
      The cells are recomputed periodically.
      See <a href="img/example02.png" target="_blank">example</a>.
    </div>
  </div>
  <div class="row">
    <div class="col b canvas">
    </div>
  </div>
  <div class="row">
    <div class="col">
      <div class="float-left">
        License: MIT
      </div>
      <div class="float-right">
        <a href="http://numpde.xyz/" target="_blank">RA</a>
        &lt;busybus &#x1f408; null.net&gt;
      </div>
    </div>
  </div>
</div>

<script>
  $("#id").resizable();
</script>

</body>
</html>
