<!DOCTYPE html>
<html lang="en">
<head>
<title>Graphical NPV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

  <script src="js/jquery.ui.touch-punch.min.js"></script>
  <script src="js/jquery.mobile-events.min.js"></script>

<!--  <script src="js/jquery-doubletap.js"></script>-->

  <link rel="stylesheet" type="text/css" href="css/main.css">

  <style type="text/css">
  </style>

</head>
<body>
<script>
    var defaultBlobW = 60;
    var defaultBlobH = 40;

    var nblobs = 0;
    var nlines = 0;

    function log(evt, what) {
      console.log({'event': (evt.type ? evt.type : evt), 'more': what});
    }

    function silence(evt) {
        evt.stopPropagation();
        evt.preventDefault();
    }


    function getLinesFromTo(a, b) {
      var lines = $("line").filter(function(i) {
        var line = $(this);
        var ia = (a === null ? true : (line.data('a') == a.data('id')));
        var ib = (b === null ? true : (line.data('b') == b.data('id')));
        return (ia & ib);
      });
      return lines;
    }


    function evaluateAll() {
      var vars = $("div.blob").toArray().reduce(
        function(acc, b) {
          acc[$(b).find(".caption").text()] = parseFloat($(b).find(".value").text());
          return acc;
        },
        {}
      );
      $("div.blob").each(function() {
        // This blob
        var b = $(this);
        // Sum from incoming connections
        var lines = getLinesFromTo(null, b).toArray();
        var insum = lines.reduce(
          function(s, line) {
            var a = $("div.blob[name=" + $(line).data('a') + "]");
            return s + parseFloat(a.find(".value").text());
          },
          0
        );
        // Current display value of the blob
        var t = b.find(".value").text();
        var f = ("" + b.data('formula'));
        // Parse formula
        f = f.includes(':') ? f.split(":", 2) : ["Result", f];
        // Compute this blob's result
        var r = NaN;
        try {
          var s = f[1].replace("#", "(" + insum + ")");
          for (var v in vars) {
            s = s.replace("$" + v, "(" + vars[v] + ")");
          }
          s = s.replace("%", " * 0.01");
          r = parseFloat(eval(s));
        } catch(err) {
          //
        }
        // Visualize result
        b.find(".caption").text("" + f[0]);
        b.find(".value").text("" + r);
      });
    }

    // On-ready: set auto-evaluate
    $(function() {
      setInterval(
        function() {
          evaluateAll();
        },
        1000
      );
    });

    function unselectAllBlobs() {
        var blobs = $("div.blob");
        blobs.removeClass("selected");
        blobs.draggable('enable');
    }

    // On-ready: register SVG arrowhead
    $( function() {
      svg = '<svg height="100%" width="100%" xmlns="http://www.w3.org/2000/svg">' +
            '<defs>' +
            '<marker id="arrowhead" class="arrow" markerWidth="13" markerHeight="13" refX="10" refY="6" orient="auto"><path d="M2,2 L2,11 L10,6 L2,2" />' +
            '</marker>' +
            '</defs>' +
            //'<line class="arrow" x1="20" y1="60" x2="100" y2="200" marker-end="url(#arrowhead)"/>' +
            '</svg>';
      $("div.canvas").append($(svg));
    } );

    function prepareLine(line) {
      line.click(function(evt) {
      });
    }

    function promptFormula(a) {
      var v = prompt("Enter cell formula:", a.data('formula'));
      if (v) {
        a.data('formula', v);
        evaluateAll();
      }
    }


    function correctLinePosition(line) {
      var a = $("div.blob[name=" + line.data('a') + "]");
      var b = $("div.blob[name=" + line.data('b') + "]");

      function getLeft(x) {
        return x.position().left + parseInt(x.css("border-left-width")) + parseInt(x.css("margin-left")) + parseInt(x.css("paddling-left"));
      }

      // https://stackoverflow.com/questions/31114656/jquery-position-include-margin
      var x1 = a.position().left + a.innerWidth() / 2;
      var y1 = a.position().top + a.innerHeight() / 2;
      var x2 = b.position().left + b.innerWidth() / 2;
      var y2 = b.position().top + b.innerHeight() / 2;
      var s = 0.55 * Math.sqrt(a.outerWidth() ** 2 + a.outerHeight() ** 2) / (1 + Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2));
      var t = 0.55 * Math.sqrt(b.outerWidth() ** 2 + b.outerHeight() ** 2) / (1 + Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2));
      line.attr('x1', x1 + s * (x2 - x1));
      line.attr('y1', y1 + s * (y2 - y1));
      line.attr('x2', x2 - t * (x2 - x1));
      line.attr('y2', y2 - t * (y2 - y1));
    }

    function correctLinesForBlob(blob) {
      $("line").each(function(i) {
        var line = $(this);
        if ((line.data('a') == blob.data('id')) || (line.data('b') == blob.data('id'))) {
          correctLinePosition(line);
        }
      })
    }

    function connectBlobs(a, b) {
      var line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      $("div.canvas svg").append(line);

      // https://stackoverflow.com/questions/8638621/jquery-svg-why-cant-i-addclass
      line.classList.add("arrow");

      line = $(line);

      line.attr('name', nlines++);
      line.data('a', a.data('id'));
      line.data('b', b.data('id'));

      prepareLine(line);

      correctLinePosition(line);
    }

    function disconnectBlobs(a, b) {
      var lines = getLinesFromTo(a, b);
      lines.remove();
    }

    function prepareBlob(blob) {
      // Order matters: https://stackoverflow.com/a/18032193

      blob.data('id', nblobs++);
      blob.data('formula', "Result: #");
      blob.attr('name', blob.data('id'));

      blob.append($('<span class="caption" /> <br> <span class="value" />'));

      function dblclick(evt) {
        if (blob.hasClass("selected")) {
          unselectAllBlobs();
        } else {
          unselectAllBlobs();
          $(blob).addClass("selected");
          $(blob).draggable('disable');
        }
        silence(evt);
      }

      blob.draggable({
        // https://jqueryui.com/draggable/#events
        'containment': "parent",
        'stop': function(evt) {
        },
        'drag': function(evt) {
          correctLinesForBlob($(this));
        },
      });

      blob.doubletap(
        function(evt) {
          dblclick(evt, this);
        }
      );

      blob.dblclick(
        {},
        function(evt) {
          dblclick(evt, this);
        }
      );


      blob.click(function(evt) {
        var a = $("div.blob.selected");
        var b = $(this);
        if (a.length) {
          unselectAllBlobs();
          if (a.is(b)) {
            promptFormula(a);
          } else {
            var lines = getLinesFromTo(a, b);
            if (lines.length) {
              disconnectBlobs(a, b);
            } else {
              connectBlobs(a, b);
            }
          }
        }
        silence(evt);
      });

      return blob;
    }

    function addBlob(to, param) {
      var ox = param.cx - param.w / 2;
      var oy = param.cy - param.h / 2;
      var css = {left: ox, top: oy, width: param.w, height: param.h};
      var blob = $('<div class="blob"></div>');
      $(to).append(blob.css(css));
      prepareBlob(blob);
    }

    // On ready: blob creation
    $(
      function() {
        var canvas = $("div.canvas");
        canvas.mousedown(silence);

        canvas.click(
          {},
          function(evt) {
            unselectAllBlobs();
          }
        );

        canvas.dblclick(
          {},
          function(evt) {
            addBlob(this, {cx: evt.offsetX, cy: evt.offsetY, w: defaultBlobW, h: defaultBlobH});
          }
        );
      }
    );

    // On-ready
    $(function() {
      $(document).keyup(function(e) {
        if (e.keyCode === 13) {

        }
        if (e.keyCode === 27) {
          unselectAllBlobs();
        }
      });
    });
  </script>


<div class="container">
  <div class="row">
    <div class="col">
      <h1>
        Graphical NPV
      </h1>
    </div>
  </div>
  <div class="row">
    <div class="col b canvas">

    </div>
  </div>
  <div class="row">
    <div class="col">
      <div class="float-right">
        &copy; 2020
        <a href="http://numpde.xyz/" target="_blank">R. Andreev</a>
      </div>
    </div>
  </div>
</div>

</body>
</html>
